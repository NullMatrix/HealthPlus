<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Health+</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<style type="text/css">
	/*Move body below nav bar*/
    body{
    	padding-top: 70px;
    }

    /*Overlay Form Styles (leaf node popup)*/
    form.leaf_overlay{
    	height:100%; 
    	width:100%; 
    	position:absolute; 
    	top:0; 
    	left:0; 
    	z-index:10; 
    	background:rgb(0,170,220); 
    	border-radius:25px;'
    }

    /*Sub-form styles*/
    fieldset.form_border{
    	border: 1px groove #ddd;
    	border-color: black;
    	padding:0px 15px 5px 15px;
    	margin: 0px 10px 10px 10px;
	}

	legend.form_border{

		width:inherit;
		padding:0px 10px 0 10px;
		border-bottom:none;
	}

	/*Ensure Modal isn't disabled due to being in a disabled container when activated*/
	div.modal-backdrop{
		z-index:0;
	}

	/*
	div.tooltip {
        position: absolute;
        text-align: center;
        width: 130px;
        height: 75px;
        padding: 6px;
        font: 12px sans-serif;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
    */

</style>

</head>
<body>

	<script>


		/************************
		*	      Global        *
		*************************/
		//user id of particpant account, to generalize have this value changed based on login credentials
		var ROOTUSER = 0;

		//logged in user profile
		var userProfile;
		//logged in user's data and metadata
		var userContent;
		var contentMetadata;

		//The content to be displayed on current page
		//root of the full content tree
		var contentRoot;
		//copy of the content tree trimmed by view permissions
		var contentView;
		//reference to location in contentView for display
		var contentNav;

		//View state so all components can be build accourdingly. Possible States:
		//owner - logged in user viewing own account as self
		//view - user viewing own account as another user
		//visit - user viewing another account basd on their permissions
		var viewState = "owner";

		//user id of user owner account being viewed as
		var viewUser;
		//user id of user being visited
		var visitUser;

		//Varible to track the current display state for the sidebar and main display
		//reference on reloads and changed on transitions.
		var sideState;
		var centreState;

		/************************
		*	     On Load        *
		*************************/

		//loads console for logging
		try {
	    	console.log
		} catch(e) {
	    	if (e) {
	        	console.log = function() {}
	    	}
		};
		
		//fetch profile and user data
		userProfile = getUser(ROOTUSER);
		userContent = getContent(ROOTUSER);
		contentMetadata = getContentMeta();

		//generate content tree

		//copy root node from metadata
		contentRoot = buildRootNode();

		var catNodes = fillCategoryNodes(buildCategoryNodes());

		//add category nodes to root
		$.each(catNodes, function(i,val){contentRoot["content"].push(val);});

		//content view is the tree pruned with permissions (not implemented at this time)
		contentView = jQuery.extend(true,{}, contentRoot);
		//set nav to root of current view
		contentNav =  contentView;
		

		$( window ).load(function() {
			//@TODO add root sidebar function as well

			//set dataview to homepage
  			document.getElementById("dataview").innerHTML = buildDataHomepage(contentNav);
		});
		


		/************************
		*	 Helper Functions   *
		*************************/

		function buildRootNode()
		{
			return jQuery.extend(true, {}, contentMetadata.root_struct);

		}

		//generate nodes for all categories and sort user content into each
		function buildCategoryNodes()
		{

			//Generate node for every known category
			var catNodes = {};

			$.each(contentMetadata.categories,function(i,val){
				catNodes[val] = jQuery.extend(true, {}, contentMetadata.root_struct);
				catNodes[val].type = "category";
				catNodes[val].category = val;
			});

			

			return catNodes;
		}

		//takes an object with category nodes and sorts and adds user content by category
		function fillCategoryNodes(catNodes)
		{
			//Sort user content into default categories
			for(i=0;i<userContent.length;i++)
			{
				//record id for edit/delete 
				var tmpContent =jQuery.extend(true,{}, userContent[i]);
				tmpContent["id"] = i;

				//function to recursively inject ID values into the data tree
				var injectID = function(curNode){
				
					if(curNode.type == "text" || curNode.type == "image" || curNode.type == "map" || curNode.type == "journal")
					{return;}

					//add id to each node in collection based on it's position in the parent array
					$.each(curNode.content,function(i,val){

						val["id"] = i;

						if(val.type == "collection"){
							injectID(val);
						}
					});
				};

				injectID(tmpContent);

				catNodes[userContent[i].category]["content"].push(tmpContent);
			}
			return catNodes;

		}


		//prune view tree based on some user's view permissions 
		function buildViewTree(viewAsUserID)
		{
			viewAsUserID = parseInt(viewAsUserID);

			var viewContent = [];
			viewContent = getVisitContent(ROOTUSER,viewAsUserID);


			//build empty category nodes
			var catNodes = buildCategoryNodes();

			//Sort user content into categories		
			$.each(viewContent, function(i,val){catNodes[val.category]["content"].push(val);})

			var viewRoot = buildRootNode();

			//add category nodes to root
			$.each(catNodes, function(i,val){viewRoot["content"].push(val);});
			
			return viewRoot;

		}//end buildViewTree

		//return true if type of node is a leaf type, important so content attribute can be correctly interpreted
		function isLeafNode(cur)
		{
			if(cur.type === "text" || cur.type === "image" || cur.type === "map")
				{return true;}
			return false;

		}

		//takes the current content pointer and returns a 6 element array which maps
		//content between content tree and content view.
		function buildContentView(cur)
		{
			
			//elements to be displayed (including controls)
			var viewableElements = [];
			viewableElements.length = 6;
			//track how many elements we have added to view so far
			var viewCount = 0;

			//add control panel
			viewableElements[viewCount] = {"type":"control"};
			viewCount++;

			//index of the next content element
			var nextElem		
			nextElem= (cur.page-1)*5;
			
			
			//fill view array
			while(viewCount < 6)
			{
				
				//check if more data exists
				if(typeof cur.content[nextElem] === 'undefined') {
    				//if content does not exist add place holders
    				viewableElements[viewCount] = {"type":"blank"};
					viewCount++;
				}
				else {
					//if content does exist add to view
					viewableElements[viewCount] = cur.content[nextElem];
					nextElem++;
					viewCount++;
    				
				}

			}//end while

			return viewableElements
		}

		//return a copy of the content object which is the parent to the child param
		function contentFindParent(child)
		{

			//return nothing if child is root
			if(child.type === "root"){return;}

			//set search to root of view tree
			var catNode = contentView;

			//return root as parent if child is a category 
			if(child.type === "category"){return catNode;}


			//select the correct category to search
			for (var i = catNode.content.length - 1; i >= 0; i--) {
				if(catNode.content[i].category === child.category)
				{
					catNode = catNode.content[i];
					break;
				}
			}


			//now that the correct category node is selected DFS through it ignoring leaf nodes
			var searchFunc = function(root,targetID){
				//If target found return itself
				if(root.id === targetID){return root;}

				//if not target and leaf type return negative match 
				if(isLeafNode(root)){return {"id":-1};}

				//recur for each child node
				for(i=0;i<root.content.length;i++)
				{

					var x = searchFunc(root.content[i],targetID);

					if(x.id === -1){continue;}//result indicates match not found
					else if(x.id === targetID){return root;}//match found return parent
					else{return x;}//parent found and returned

				};

				return {"id":-1};
			}//end searchFunc

			var parent = searchFunc(catNode,child.id);

			if(parent.id === 'undefined'){return catNode;}//categories have no id
			else if(parent.id === -1){return {"type":"blank"};} //id of -1 indicates no match found for child
			//otherwise parent found

			return parent;
		}

		//generate the list of the current user's circles that can access a given piece of data
		function accessListCircles(data = contentNav)
		{	
			//list of groups with access to data
			var accessList = new Array;

			//retrieve the tags from the data in question
			var tags = data.tags;

			//retrieve the current user's access control info
			var circles = userProfile.circles;

			//for each circle defined by the user
			$.each(Object.keys(circles), function(i,cirVal){
				//loop through the list of tags with access to current data
				for(i=0;i<tags.length;i++)
				{
					//and check if that tag is in the circle's tags
					if($.inArray(tags[i],circles[cirVal].tags) > -1)
					{
						//if so add name of circle to return list
						accessList.push(cirVal);
						break;
					}
				}
			});

			return accessList;
		}

		//generate the list of the current user's friends that can access a given piece of data
		function accessListUsers(data = contentNav)
		{	
			//list of groups with access to data
			var accessList = new Array;

			//retrieve the tags from the data in question
			var tags = data.tags;

			//retrieve the current user's access control info
			var circles = userProfile.circles;

			//for each circle defined by the user
			$.each(Object.keys(circles), function(i,cirVal){
				//loop through the list of tags with access to current data
				for(i=0;i<tags.length;i++)
				{
					//and check if that tag is in the circle's tags
					if($.inArray(tags[i],circles[cirVal].tags) > -1)
					{	

						//add each member of the circle to the access list if they aren't in it
						$.each(circles[cirVal].members, function(i,userVal){

							if($.inArray(userVal,accessList) < 0){
								accessList.push(userVal);
							}

						});
						break;
					}
				}
			});

			var userNames = new Array;
			$.each(getUserset(accessList), function(i,val){
				userNames.push(val.fName +" "+val.lName);

			});

			return userNames;
		}

		



		/************************
		*	   Event Handlers   *
		*************************/




		//button handler for nav bar buttons
		function sideBarChange(buttonElement){
			//alert(buttonElement.id);
			var buttonClickedId = buttonElement.id;
			  
			//set active button
			var x = document.getElementsByClassName("active");
			var i;
				for (i = 0; i < x.length; i++) {
					x[i].setAttribute("class","inactive");
				}
			document.getElementById(buttonClickedId).setAttribute("class","active");

			//button handlers
			if( buttonClickedId === 'btnCircles' ){
				sideState = "circles";
				document.getElementById("sidebar").innerHTML= buildMainSidebar();
			}
			else if( buttonClickedId === 'btnPeople' ){
				sideState = "people";
				document.getElementById("sidebar").innerHTML= buildMainSidebar();
			}
			else if( buttonClickedId === 'btnData' ){
				sideState = "data";
				document.getElementById("sidebar").innerHTML= buildMainSidebar();
				
			}
			else{
				/*
				document.getElementById("sidebar").innerHTML=
				"<p>"+buttonClickedId+"</p>";
				*/
				//contentView = buildViewTree(3);
				//contentNav = contentView;
				//document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
				//console.log(getVisitContent(0,3));
				//document.getElementById("dataview").innerHTML= buildMainDataview(contentNav)
			}

		}

		//this function handles buttons in the data view
		//moves the data nav ptr and rebuilds data view html
		function dataNavChange(buttonElement)
		{	

			//if contentNav type is root handle category selection
			if(contentNav.type === "root")
			{

				for (var i = contentNav.content.length - 1; i >= 0; i--) {
					if(contentNav.content[i].category === buttonElement.value)
					{
						contentNav = contentNav.content[i];
						contentNav["page"] = 1;
						break;
					}
				}
				document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
				return;
			}
			
			//not root node so generate current data view
			var view = buildContentView(contentNav);
			//get user's selected element
			var select = parseInt(buttonElement.value);
			
			//delete the page attribute from current node
			delete contentNav.page;

			//find the selected node and move the nav
			for(i=0;i<contentNav.content.length;i++)
			{
				//console.log(view[select]);
				//console.log(contentNav.content[i]);

				if(view[select].id == contentNav.content[i].id)
				{
					contentNav = contentNav.content[i];
					contentNav["page"] = 1;
					break;
				}

			}



			//reload dataview (add overlay for leaf)
			if(isLeafNode(contentNav))
			{
				document.getElementById("dataview").innerHTML += buildMainDataview(contentNav);
				return;

			}
			document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
		}


		//Event handler for navigation buttons within the collection/journal data view
		function dataNavControl(buttonElement)
		{

			//move the nav back to root for home
			if(buttonElement.value === "home")
			{
				//delete page element could be removed to "remember" where the user was in a collection
				delete contentNav.page;

				//reset the nav
				contentNav = contentView;

			}else if (buttonElement.value === "up")
			{
				delete contentNav.page;

				//move data nav to parent
				contentNav = contentFindParent(contentNav);
				contentNav["page"] = 1;
				
			}else if(buttonElement.value === "back")
			{
				//reduce page value and reload 
				contentNav.page--;

			}else if(buttonElement.value === "forward")
			{
				//increase page value and reload
				contentNav.page++;
			}

			//reload view with new/changed data
			document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
			//document.getElementById("sidebar").innerHTML = buildMainSidebar("people");
			return;
		}

		function accessListViewChange(radioElement)
		{

			var newList = "";
			var newData = new Array;

			//select the correct access list based on radio selected
			if(radioElement.value === "circle")
			{
				newData = accessListCircles();
			}
			else
			{
				newData = accessListUsers();
			}

			//build up a valid html string replacement for the list element
			for(i=0;i<newData.length;i++)
			{
				newList += "<li>"+newData[i]+"</li>";
			}
  
  			//find the access display and replace the list elements
    		document.getElementById("dataACList").innerHTML = newList;

		}


		function sidebarUserOptions(buttonelement)
		{

			//console.log("User ID: " + $(buttonelement).parent().attr('value') + " Button: " + buttonelement.value);

			if(buttonelement.value === "view")
			{
				viewState = "view"; 
				viewUser = $(buttonelement).parent().attr('value');

				contentView = buildViewTree($(buttonelement).parent().attr('value'));
				contentNav = contentView;
				document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
				document.getElementById("sidebar").innerHTML = buildMainSidebar();

			}
			else if(buttonelement.value === "visit")
			{
				console.log("VISIT");

				viewState = "visit"; 
				viewUser = $(buttonelement).parent().attr('value');

				//@TODO - create function to build visit tree
				//contentView = buildViewTree($(buttonelement).parent().attr('value'));
				//contentNav = contentView;

				document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
				document.getElementById("sidebar").innerHTML = buildMainSidebar();
			}
			else if(buttonelement.value === "edit")
			{
				console.log("EDIT");
			}
			else if(buttonelement.value === "exit")
			{
				viewState = "owner"; 
				contentView = jQuery.extend(true,{}, contentRoot);;
				contentNav = contentView;
				document.getElementById("dataview").innerHTML = buildMainDataview(contentNav);
				document.getElementById("sidebar").innerHTML = buildMainSidebar();
			}

		}

		function sidebarCircleOptions(buttonelement){

			//@TODO add button for new circle
			//@TODO repurpose edit screen for new circle
			//console.log(buttonelement.value);
			document.getElementById("dataview").innerHTML = buildCircleEdit(buttonelement.value);
		}

		function sidebarDataSearch(){

			var searchResults = getSearchResults(document.getElementById("search").value);
			var args = [{},searchResults]
			sideState = "data"
			document.getElementById("sidebar").innerHTML = buildMainSidebar(args);
		}

		function sidebarPersonSearch()
		{
			userProfile.friends = getSearchPeopleResults(document.getElementById("search").value); 
			sideState = "people";
			document.getElementById("sidebar").innerHTML =buildMainSidebar();
		}


		//onclick function to move values between selection boxes on circle editing screen
		function swapSelection(src, dest)
		{
			//if no selection do nothing
			if(src.value === '')
				return

			//Create new option and add to dest
			var option = document.createElement("option");

			option.text = src.options[src.selectedIndex].text;
			option.value = src.options[src.selectedIndex].value;

			dest.add(option);

			//remove option @ selected index from src
			src.remove(src.selectedIndex);
			
		} 

		//onclick event for new tag within new/edit circle screen
		function submitNewTag()
		{
			//retrieve the tag
			var tag = document.getElementById('newTagtxt').value
			
			//post to server and clear input
			postNewTag(tag);
			document.getElementById('newTagtxt').value = '';

			//update local user after post
			userProfile = getUser(ROOTUSER);
			console.log(userProfile)

			//add tag to select
			var option = document.createElement("option");
			option.text = tag;
			option.value = tag;
			document.getElementById("tagOut").add(option);

		}

		/************************
		*	Query Functions   *
		*************************/

		function getSearchPeopleResults(queryString,last) {
			//async query the server for a profile and return JSON obj

		    return $.ajax({
		        type: "GET",
		        url: "/searchPeople?userID="+ROOTUSER+"&queryString="+queryString,
		        async: false

		    }).responseJSON;
		}

		function getSearchResults(queryString,last) {
			//async query the server for a profile and return JSON obj

		    return $.ajax({
		        type: "GET",
		        url: "/searchData?userID="+ROOTUSER+"&queryString="+queryString,
		        async: false

		    }).responseJSON;
		}

		function getUserset(ids,last) {
			//async query the server for a profile and return JSON obj

			userQuery = "";

			//build query string from ids provided
			for(i=0;i<ids.length;i++)
			{
				userQuery += ids[i] + ",";
			}
			//remove trailing comma
			userQuery = userQuery.slice(0,-1);

		    return $.ajax({
		        type: "GET",
		        url: "/userset?users=["+userQuery+"]",
		        async: false

		    }).responseJSON;
		}

		function getUser(id,last) {
			//async query the server for a profile and return JSON obj

		    return $.ajax({
		        type: "GET",
		        url: "/data/user/"+id,
		        async: false

		    }).responseJSON;
		}

		function getContent(id,last) {
			//async query the server for a user's content and return JSON obj

		    return $.ajax({
		        type: "GET",
		        url: "/data/content/"+id,
		        async: false

		    }).responseJSON;
		}

		function getContentMeta(last) {
			//async query the server for content metadata and return JSON obj

		    return $.ajax({
		        type: "GET",
		        url: "/data/content/meta",
		        async: false

		    }).responseJSON;
		}

		//retrive info on toUser account bounded by fromUser permissions
		function getVisitContent(toUser, fromUser, last){

			return $.ajax({
		        type: "GET",
		        url: "/visitUser?to="+toUser+"&from="+fromUser,
		        async: false

		    }).responseJSON;
		}

		//post function to create new tags
		function postNewTag(newTag, last)
		{
			return $.ajax({
				type: "POST",
				url: "/newTag?userID="+ROOTUSER+"&newTag="+newTag,
				async: false
			}).responseJSON;
		}

		//post function to update circle info
		function postUpdateCircle(newCir, last)
		{
			//@TODO: update ajax call to include stringified newCir 
			return $.ajax({
				type: "POST",
				url: "/newTag?userID="+ROOTUSER+"&newTag="+newTag,
				async: false
			}).responseJSON;
		}

		/************************
		*	Builder Functions   *
		*************************/



		//function used to reload data view
		function buildMainDataview(cur)
		{

			//if root node create special category selection controls
			if(cur.type === "root")
				{return buildDataHomepage(cur);}

			//if cur ptr is a leaf create a data editor overlay
			if(isLeafNode(cur))
				{return buildDataLeaf(cur);}

			return buildDataCollection(cur);		
		}


		//Build Side bar HTML String based on sideState
		//People, circles, data
		//Params
		//args - additional arguments if availible
			//For Data
				//args[0] - search result on circle names
				//args[1] - search result on data
		function buildMainSidebar(args=[])
		{
			var sidebar = ""

			if(sideState == "people")
			{
				sidebar = buildSideBarMessages() + buildSidebarPeople();
			}
			else if(sideState == "circles")
			{
				sidebar = buildSideBarMessages() + buildSidebarCircles();
			}
			else if(sideState == "data")
			{
				sidebar = buildSideBarMessages() 
				if(args.length >=2)
				{
					sidebar += buildSidebarData(args[0],args[1]);
				}
				else
				{
					sidebar += buildSidebarData();
				}

			}

			return sidebar;

		}


		function buildSideBarMessages()
		{
			var side = "";

			if(viewState == "view")
			{
				side += "<p>VIEWING AS: ";

				var viewUserTemp = getUser(viewUser);
				side += viewUserTemp.fName + " " + viewUserTemp.lName;

				side += "<button type='button' onclick='sidebarUserOptions(this)' value='exit' style='height:95%; width:15%;'>Exit View</button>";
				side += "</p>"
			}
			else if(viewState == "visit")
			{
				side += "<p>Visiting: ";

				var viewUserTemp = getUser(viewUser);
				side += viewUserTemp.fName + " " + viewUserTemp.lName;

				side += "<button type='button' onclick='sidebarUserOptions(this)' value='exit' style='height:95%; width:15%;'>Exit Visit</button>";
				side += "</p>"
				side += "<br><p>Note: Data currently shown belongs to another user.</p>"
			}

			return side; 

		}

		//return html for side bar view of friends
		function buildSidebarPeople()
		{

				var side = "";
				side += "<form>Search:&nbsp;&nbsp;<input id='search' type='text'name='search'>&nbsp;&nbsp;<input type='button'value='search' onclick='sidebarPersonSearch()'></form>";

				side += "<ul class='list-group' style='width:350px;'>";

				var friend = {};
				for(var i=0; i<userProfile.friends.length;i++)
				{
					//@TODO use the get userset query to streamline this
					friend = getUser(userProfile.friends[i]);

					//console.log(friend)
					side += "<li href='#' class='list-group-item' value="+friend.id+" style='height:75px'>";
					side += "<img src='/asset/"+friend.id+"' height=20 width=20></img>";
					side += friend.fName +" "+friend.lName +" ";
					side += "<button type='button' onclick='sidebarUserOptions(this)' value='view' style='height:95%; width:15%;'>View</button>";
					side += "<button type='button' onclick='sidebarUserOptions(this)' value='visit' style='height:95%; width:15%;'>Visit</button>";
					side += "<button type='button' onclick='sidebarUserOptions(this)' value='edit' style='height:95%; width:15%;'>Edit</button>";
					side += "</li>";
				}
				side += "</ul>";
				

				return side;
		}

		function buildSidebarCircles()
		{

			var side = "";

			side += "<button class='btn btn-info' style='display:block;margin-left:auto;margin-right:auto;margin-bottom:15px' >New Circle</button>";

			side += "<ul class='list-group' style='width:350px;'>";

			$.each(Object.keys(userProfile.circles), function(i,val){
				side += "<li href='#' class='list-group-item' style='height:75px'>";
				side += "<img src='/asset/"+userProfile.circles[val].image+"' height=20 width=20></img>";
				side += val + " ";
				side += "<button type='button' onclick='sidebarCircleOptions(this)' value='"+val+"' style='height:95%; width:15%; float:right;'>Edit</button>";
				side += "</li>";
			});

			side += "</ul>";

			return side;
		}

		//parmas
		//circleSearch - results from search on circle names
		//dataSearch - results from search on data
		function buildSidebarData(circleSearch = [], dataSearch = [])
		{

			var side = "";

			//@TODO Searchbar field
			//@TODO Create Search button handler

			side += "<form>Search:&nbsp;&nbsp;<input id='search' type='text'name='search'>&nbsp;&nbsp;<input type='button'value='search' onclick='sidebarDataSearch()'></form>";

			//@TODO Search Categories
			//Example code: http://bootsnipp.com/snippets/featured/accordion-menu

			side += "<div id='SRAccordian' class='panel-group'>";

			side += "<div class='panel panel-default'>";
			side += "<div class='panel-heading'>";
			side += "<a href='#circleSR' data-parent='#SRAccordian' class='btn btn-info' data-toggle='collapse'>Your Circles</a>";
			side += "</div>";
			side += "<div id='circleSR' class='panel-collapse collapse'>";
			side += "<div class='panel-body'>";
			side += "<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit</p>";
			side += "</div></div></div>";
			
			side += "<div class='panel panel-default'>";
			side += "<div class='panel-heading'>";
			side += "<a href='#peopleSR' data-parent='#SRAccordian' class='btn btn-info' data-toggle='collapse'>People You Know</a>";
			side += "</div>";
			side += "<div id='peopleSR' class='panel-collapse collapse'>";
			side += "<div class='panel-body'>";


			//add data search results to accordian
			side += "<ul class='list-group' style='width:350px;'>";
			for(i=0;i<dataSearch.length;i++)
			{
				side += "<li href='#' class='list-group-item' style='height:75px'>";
				side += "<p>";
				side += "<b>"+dataSearch[i].title+"</b><br>";
				side += dataSearch[i].content;
				side += "</p>";
				side += "</li>";
			}
			side += "</ul>"


			side += "</div></div></div>";

			/*
			side += "<div class='panel panel-default'>";
			side += "<div class='panel-heading'>";
			side += "<a href='#foffSR' data-parent='#SRAccordian' class='btn btn-info' data-toggle='collapse'>People You May Know</a>";
			side += "</div>";
			side += "<div id='foffSR' class='panel-collapse collapse'>";
			side += "<div class='panel-body'>";
			side += "<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit</p>";
			side += "</div></div></div>";
			*/

			side += "</div>";

			return side;
		}

		/*
			side += "<a href='#circleSR' class='btn btn-info' data-toggle='collapse'>Your Circles</a>";
			side += "<div id='circleSR' class='collapse'>Lorem ipsum dolor sit amet, consectetur adipisicing elit</div>";

			side += "<a href='#peopleSR' class='btn btn-info' data-toggle='collapse'>People You Know</a>";
			side += "<div id='peopleSR' class='collapse'>Lorem ipsum dolor sit amet, consectetur adipisicing elit</div>";

			side += "<a href='#foffSR' class='btn btn-info' data-toggle='collapse'>People You May Know</a>";
			side += "<div id='foffSR' class='collapse'>Lorem ipsum dolor sit amet, consectetur adipisicing elit</div>";
		*/

		
		//builder function for root node view with selection options for each availible category
		//collections are taken from the metadata in the content storage
		function buildDataHomepage(root)
		{
			var btnCount=0;

			var homepage = "";

			homepage += "<div class='container' style='height:inherit;width:inherit;'>"

			for(i=0;i<2;i++)
			{
				homepage += "<div class='row' style='height:50%;width:inherit;'>"
				for(j=0;j<2;j++)
				{
					homepage += "<div class='col-md-6' style='height:100%; width:50%'>"
			
					homepage +="<button type='button' onclick='dataNavChange(this)' value='"+root.content[btnCount].category+"' style='height:95%;width:100%'>"+root.content[btnCount].category+"</button>";
					btnCount++;

					homepage += "</div>"
				}			
				homepage += "</div>"
			}
			homepage += "</div>"

			return homepage
		}

		//builder for standard collection view, 
		function buildDataCollection(cur){

			var contentMap = buildContentView(cur)
			var contentCount = 0;

			var page = "";

			page += "<div class='container' style='height:inherit;width:inherit;'>"

			for(i=0;i<2;i++)
			{
				page += "<div class='row' style='height:50%;width:inherit;'>"
				for(j=0;j<3;j++)
				{
					page += "<div class='col-md-4' style='height:97%; width:32%'>"
					

					//get the data type and create preview
					if(contentMap[contentCount].type === "control")
					{
						//function builds control buttons html
						page +=  buildDataControlPanel(cur);

						contentCount++;
					}
					else if(contentMap[contentCount].type === "collection")
					{
						//@TODO: Needs count of elements in collection (preview?)
						page +=  "<button type='button' onclick='dataNavChange(this)' value="+contentCount+" style='height:95%; width:100%;'>";
						page += "<img src='/asset/icon_collect' height='50' width='50'></img>";
						page += "<p>"+contentMap[contentCount].type+"<br>"+contentMap[contentCount].title+"</p>";
						page += "</button>"; 
						contentCount++;
					}
					else if(contentMap[contentCount].type === "text")
					{
						//@TODO: better title formating 
						
						page +=  "<button type='button' onclick='dataNavChange(this)' value="+contentCount+" style='height:95%; width:100%;'>";
						page += "<img src='/asset/icon_text' height='50' width='50'></img>";
						page += "<p>"+contentMap[contentCount].type +"<br>"+contentMap[contentCount].title+"</p>";
						page += "</button>"; 
						contentCount++;
					}
					else if(contentMap[contentCount].type === "image")
					{
						//@TODO: show preview or picture icon
						page +=  "<button type='button' onclick='dataNavChange(this)' value="+contentCount+" style='height:95%; width:100%;'>";
						page += "<img src='/asset/icon_img' height='50' width='50'></img>";
						page += "<p>"+contentMap[contentCount].type+"</p>";
						page += "</button>"; 
						contentCount++;
					}
					else if(contentMap[contentCount].type === "map")
					{
						//@TODO: show map icon
						page +=  "<button type='button' onclick='dataNavChange(this)' value="+contentCount+" style='height:95%; width:100%;'>";
						page += "<img src='/asset/icon_map' height='50' width='50'></img>";
						page += "<p>"+contentMap[contentCount].type+"</p>";
						page += "</button>"; 
						contentCount++;
					}
					else if(contentMap[contentCount].type === "Journal")
					{
						//@TODO: journal icon and count
						page +=  "<button type='button' onclick='dataNavChange(this)' value="+contentCount+" style='height:95%; width:100%;'>";
						page += "<img src='/asset/icon_journal' height='50' width='50'></img>";
						page += "<p>"+contentMap[contentCount].type+"</p>";
						page += "</button>"; 
						contentCount++;
					}
					else{
						//ignore blanks but ensure the spacing 
						contentCount++;
					}	
					page += "</div>"
				}			
				page += "</div>"
			}
			page += "</div>"
			return page
		}

		//return html string for control buttons
		function buildDataControlPanel(cur)
		{

			var page = "";

			//home button
			page +=  "<button type='button' onclick='dataNavControl(this)' value='home' style='height:15%; width:100%;'>";
			page += "<img src='/asset/home' height='30' width='30'></img>";
			page += "</button>"; 

			//up button
			page +=  "<button type='button' onclick='dataNavControl(this)' value='up' style='height:25%; width:100%;'>";
			page += "<img src='/asset/arrow_up' height='50' width='50'></img>"; 
			page += "</button>"; 

			//back button
			page +=  "<button type='button' onclick='dataNavControl(this)' value='back' style='height:50%; width:50%;' ";
			if(cur.page == 1){ page+="disabled"} //disable if page 1
			page +=">"
			page += "<img src='/asset/arrow_left' height='50' width='50'";
			if(cur.page == 1){ page+="style='opacity:0.3;'";}//grey icon if disabled 
			page += "></img>"; 
			page += "</button>"; 

			//forward button
			page +=  "<button type='button' onclick='dataNavControl(this)' value='forward' style='height:50%; width:50%; display:inline;' ";
			if(cur.page >= (cur.content.length/5)){ page+="disabled"}//disable if no more data
			page += ">"; 
			page += "<img src='/asset/arrow_right' height='50' width='50'";
			if(cur.page >= (cur.content.length/5)){ page+="style='opacity:0.3;'";}//grey icon if disabled 
			page += "></img>"; 
			page+="</button>";

			return page;

		}

		//builds a viewer/editor for the specific type of data  selected
		function buildDataLeaf(cur){


			var page = "";

			page += "<form class='leaf_overlay'>";

			//title row			
			page += "<div style='text-align:center;' class='form-group row'>";
			page += 	"<div class='col-md-12'>";
			page += 		"<h2 style='text-align:center;'><br>Title: "+cur.title+"<br></h2>";
			page += "</div></div>";

			//content display
			page += "<div style='text-align:center;' class='form-group row'>";
			page += "<div class='col-md-12'>";
			page += "<fieldset class='center-block' style='width:80%;' class='form-group'>";
			
			if(cur.type == "text")
			{
				page += "<label for='contentDisplay'>Content</label>";
   				page += "<textarea class='form-control' id='contentDisplay' rows='8'></textarea>";

			}
			else if(cur.type == "image")
			{
				page+= "<img src='/asset/"+cur.content+"' height='200' width='200'></img>";
			}
			else if(cur.type == "map")
			{
				page += "<p>MAP!</p>";
			}

			page += "</fieldset>";
			page += "</div></div>";


			
			page += "<div class='form-group row'>";

			//property editor/viewer
			page += "<div style='text-align:center;' class='col-md-6'>";
			page += "<fieldset class='form_border'>";

			page += "<legend class='form_border'>";
			page += "<button class='btn-info' type='button'>Edit</button>";
			page += "</legend>";

			page += "<label>Created:</label>";
			page += "<label>"+cur.created+"</label>";
			page += "<br>";

			page += "<label>Last Edit:</label>";
			page += "<label>"+cur.last_edit+"</label>";
			page += "<br>";

			page += "<div style='text-align:center;'>"
			page += "<label style='vertical-align:top;'>Tags:</label>";
			page += "<select multiple disabled style='width:30%;'>";
			for(i=0;i<cur.tags.length;i++)
			{
				page += "<option>"+cur.tags[i]+"</option>";
			}
    		page += "</select>";
    		page += "</div>"

			page += "</fieldset>"
			page += "</div>";//end col

			//membership viewer
			page += "<div style='text-align:center;' class='col-md-6'>";
			page += "<fieldset class='form_border'>";


			//radio buttons to switch between seeing circle access and user access
			page += "<legend class='form_border'>";
			page += "<div class='radio-inline'>"
    		page += "<label>"
      		page += "<input type='radio' name='accessList' onclick='accessListViewChange(this)' id='cirAccessRdo' value='circle' checked>"
      		page += "Circles"
 			page += "</label>"
  			page += "</div>"

  			page += "<div class='radio-inline'>"
    		page += "<label>"
      		page += "<input type='radio' name='accessList' onclick='accessListViewChange(this)' id='userAccessRdo' value='user'>"
      		page += "People"
    		page += "</label>"
  			page += "</div>"
  			page += "</legend>";


			page += "<div style='display:inline-block;'>"
			page += "<label style='vertical-align:top;'>Access:</label>";
			page += "<ul id='dataACList' style='list-style-type:none; width:100%;'>";

			//generate access list
			var circles = accessListCircles(cur);

			for(i=0;i<circles.length;i++)
			{
				page += "<li>"+circles[i]+"</li>";
			}
    		page += "</ul>";
    		page += "</div>"

			page += "</fieldset>"
			page += "</div>";//end col


			page += "</div>";//end row

			
			page += "<div style='text-align:center;' class='form-group row'>";

			page += "<div class='col-md-12'>";

			page +=  "<button type='button' style='btn-primary inline' onclick='dataNavControl(this)' value='up' style='height:25%; width:100%;'>";
			page += "Back"; 
			page += "</button>";
			page +=  "<button type='button' style='btn-primary' style='height:25%; width:100%;'>";
			page += "Commit"; 
			page += "</button>";


			page += "</div>"; //end col

			page += "</div>"; //end row


			page += "</form>"; 

			return page;
		}

		//@TODO builder for comfirmation popup when making edits in data view
		function buildComfPage(cur)
		{
			var page = "";

			page += "<form class='leaf_overlay'>";

			//title row			
			page += "<div style='text-align:center;' class='form-group row'>";
			page += 	"<div class='col-md-12'>";
			page += 		"<h2 style='text-align:center;'><br>Title: "+cur.title+"<br></h2>";
			page += "</div></div>";

			//content display
			page += "<div style='text-align:center;' class='form-group row'>";
			page += "<div class='col-md-12'>";
			page += "<fieldset class='center-block' style='width:80%;' class='form-group'>";
			
			if(cur.type == "text")
			{
				page += "<label for='contentDisplay'>Content</label>";
   				page += "<textarea class='form-control' id='contentDisplay' rows='8'></textarea>";

			}
			else if(cur.type == "image")
			{
				page+= "<img src='/asset/"+cur.content+"' height='200' width='200'></img>";
			}
			else if(cur.type == "map")
			{
				page += "<p>MAP!</p>";
			}

			page += "</fieldset>";
			page += "</div></div>";


			
			page += "<div class='form-group row'>";

			//property editor/viewer
			page += "<div style='text-align:center;' class='col-md-6'>";
			page += "<fieldset class='form_border'>";

			page += "<legend class='form_border'>";
			page += "<button class='btn-info' type='button'>Edit</button>";
			page += "</legend>";

			page += "<label>Created:</label>";
			page += "<label>"+cur.created+"</label>";
			page += "<br>";

			page += "<label>Last Edit:</label>";
			page += "<label>"+cur.last_edit+"</label>";
			page += "<br>";

			page += "<div style='text-align:center;'>"
			page += "<label style='vertical-align:top;'>Tags:</label>";
			page += "<select multiple disabled style='width:30%;'>";
			for(i=0;i<cur.tags.length;i++)
			{
				page += "<option>"+cur.tags[i]+"</option>";
			}
    		page += "</select>";
    		page += "</div>"

			page += "</fieldset>"
			page += "</div>";//end col

			//membership viewer
			page += "<div style='text-align:center;' class='col-md-6'>";
			page += "<fieldset class='form_border'>";


			//radio buttons to switch between seeing circle access and user access
			page += "<legend class='form_border'>";
			page += "<div class='radio-inline'>"
    		page += "<label>"
      		page += "<input type='radio' name='accessList' onclick='accessListViewChange(this)' id='cirAccessRdo' value='circle' checked>"
      		page += "Circles"
 			page += "</label>"
  			page += "</div>"

  			page += "<div class='radio-inline'>"
    		page += "<label>"
      		page += "<input type='radio' name='accessList' onclick='accessListViewChange(this)' id='userAccessRdo' value='user'>"
      		page += "People"
    		page += "</label>"
  			page += "</div>"
  			page += "</legend>";


			page += "<div style='display:inline-block;'>"
			page += "<label style='vertical-align:top;'>Access:</label>";
			page += "<ul id='dataACList' style='list-style-type:none; width:100%;'>";

			//generate access list
			var circles = accessListCircles(cur);

			for(i=0;i<circles.length;i++)
			{
				page += "<li>"+circles[i]+"</li>";
			}
    		page += "</ul>";
    		page += "</div>"

			page += "</fieldset>"
			page += "</div>";//end col


			page += "</div>";//end row

			
			page += "<div style='text-align:center;' class='form-group row'>";

			page += "<div class='col-md-12'>";

			page +=  "<button type='button' style='btn-primary inline' onclick='dataNavControl(this)' value='up' style='height:25%; width:100%;'>";
			page += "Back"; 
			page += "</button>";
			page +=  "<button type='button' style='btn-primary' style='height:25%; width:100%;'>";
			page += "Commit"; 
			page += "</button>";


			page += "</div>"; //end col

			page += "</div>"; //end row


			page += "</form>"; 

			return page;
		}


		//build the editing screen for a circle
		//Param circleName is a string of the circle to be editied
		function buildCircleEdit(circleName)
		{
			
			//@TODO: New Tag option near tag controls
			//@TODO: Commit Changes (Push) and reload local profile
			//@TODO: Repurpose for New Circle screen
				

			var page = "";

			page += "<form class='leaf_overlay'>";

			//Page Header (10% - T: 10%)
			page += "<div class='row' style='height:10%;width:inherit;text-align:center;'>"
			page += "<br><h4>Circle info :)</h4></br>"
			page += "</div>"

			//Circle name (10% - T: 20%)
			page += "<div class='row' style='height:10%;width:inherit;'>"
				page += "<div class='col-md-12'>"
					page += "<input type='text' class='form-control center-block' id='cirName' value='"+circleName+"' style='height:inherit;width:25%;text-align:center;' disabled>";
					//@TODO Attach label to above input and investigate css
					//page += "<label for='cirName'>Circle Name</label><br>";
				page += "</div>"
			page += "</div>"

			//People Header (5% - T: 25%)
			page += "<div class='row' style='height:5%;width:inherit;text-align:center;'>"
			page += "<h4>Circle Members:</h4>"
			page += "</div>"

			//People Selecter (30% - T: 55%)
			page += "<div class='row' style='height:30%;width:inherit;text-align:center;'>"
				//Current People
				page += "<div class='col-md-5'>"
					page += "<p>Members Currently In Circle</p>"
					page += "<select class='center-block' name='peopleIn' size='6' style='width:70%;'>";

					var incFriendIndex = userProfile.circles[circleName].members;
					$.each(getUserset(incFriendIndex), function(i,val){page += "<option value='"+incFriendIndex[i]+"'>"+val.fName+" "+val.lName+"</option>"});

					page += "</select>"
				page += "</div>"
				//transfer buttons
				page += "<div class='col-md-2' style='height:100%;display:flex;align-items:center;'>"
					page += "<div class='text-center' style='margin:0px auto;'>"
						page += "<button type='button' style='btn-primary' value='reload' onClick='swapSelection(peopleOut,peopleIn)' style='height:100%; width:100%;'><<</button><br>";
						page += "<button type='button' style='btn-primary' value='reload' onClick='swapSelection(peopleIn,peopleOut)'style='height:100%; width:100%;'>>></button>";
					page += "</div>"
				page += "</div>"
				//Other people
				page += "<div class='col-md-5'>"
					page += "<p>Members Not In Circle</p>"
					page += "<select class='center-block' name='peopleOut' size='6' style='width:70%;'>";

					var otherFriendsIndex = $(userProfile.friends).not(userProfile.circles[circleName].members).get();	
					$.each(getUserset(otherFriendsIndex), function(i,val){page += "<option value='"+otherFriendsIndex[i]+"'>"+val.fName+" "+val.lName+"</option>"});

					page += "</select>"
				page += "</div>"
			page += "</div>"

			//Tag Header (5% - T: 60%)
			page += "<div class='row' style='height:5%;width:inherit;text-align:center;'>"
			page += "<h4>Circle Tags:</h4>"
			page += "</div>"

			//Tag Selecter(30% - T: 90%)
			page += "<div class='row' style='height:30%;width:inherit;text-align:center;'>"
				//Current Tags
				page += "<div class='col-md-5'>"
					page += "<p>Current Tags</p>"
					page += "<select class='center-block' name='tagIn' size='6' style='width:70%;'>";
					$.each(userProfile.circles[circleName].tags, function(i,val){page += "<option value='"+val+"'>"+val+"</option>"});
					page += "</select>"
				page += "</div>"
				//transfer buttons
				page += "<div class='col-md-2' style='height:100%;display:flex;align-items:center;'>"
					page += "<div class='text-center' style='margin:0px auto;'>"
						page += "<button type='button' style='btn-primary' value='reload' onClick='swapSelection(tagOut,tagIn)' style='height:100%; width:100%;'><<</button><br>";
						page += "<button type='button' style='btn-primary' value='reload' onClick='swapSelection(tagIn,tagOut)' style='height:100%; width:100%;'>>></button>";
					page += "</div>"
				page += "</div>"
				//Other tags
				page += "<div class='col-md-5'>"
					page += "<p>All Tags</p>"
					page += "<select class='center-block' name='tagOut' id='tagOut' size='6' style='width:70%;'>";
					$.each($(userProfile.tags).not(userProfile.circles[circleName].tags).get(), function(i,val){page += "<option value='"+val+"'>"+val+"</option>"});
					page += "</select>"

					//New Tag button + popup

					page += "<button type='button' style='btn-info' data-toggle='modal' data-target='#tagModal'>New Tag</button>";
					
					page += "<div id='tagModal' class='modal fade' role='dialog'>";
						page += "<div class='modal-dialog'>";
							page += "<div class='modal-content'>";
								page += "<div class='modal-header'>";
									page += "<button type='button' class='close' data-dismiss='modal'>&times;</button>";
									page += "<h4>Create New Tag</h4>";
								page += "</div>";
							page += "<div class='modal-body'>";
								page += "<p>Please enter new tag:</p>";
								page += "<textarea id='newTagtxt' rows='1' maxlength='20' style='resize:none;'></textarea>";
							page += "</div>"
							page += "<div class='modal-footer'>";
							page += "<button type='button' class='btn btn-success' onclick='submitNewTag()' data-dismiss='modal'>Save</button>";
								page += "<button type='button' class='btn btn-warning' data-dismiss='modal'>Cancel</button>";
							page += "</div>"



							page += "</div>";
						page += "</div>";
					page += "</div>";

				page += "</div>"
			page += "</div>"
			//Footer Comf/Cancel (10% - T: 100%)
			page += "<div class='row' style='height:10%;width:inherit;text-align:center;'>"
			page += "<button type='button' style='btn-primary' onclick='dataNavControl(this)' value='reload' style='height:100%; width:100%;'>Return</button>";
			page += "</div>"


			
			

			//Middle row with person membership
			page += "<div class='row' style='height:33%;width:inherit'>"
			page += "</div>"

			//Bottom ro w with circle membership
			page += "<div class='row' style='height:33%;width:inherit'>"
			page += "</div>"



			page += "</form>"; 

			return page;
		}

	</script>



	<div class="container">
		
		<nav id="myNavbar" class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
				<div class="container">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarCollapse">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
				<a class="navbar-brand" href="#">Health+</a>
				</div>
				<div class="collapse navbar-collapse" id="navbarCollapse">
				<ul class="nav navbar-nav">
					<li id="btnCircles" onclick="sideBarChange(this)">
						<a target="_blank">
							<span class="glyphicon glyphicon-plus-sign"></span>
							Your Circles
						</a>
					</li>
					<li id="btnPeople" onclick="sideBarChange(this)"><a target="_blank">
							<span class="glyphicon glyphicon-user"></span>
							Your People 
							<span class="badge">25</span>
						</a>
					</li>
					<li id="btnData" onclick="sideBarChange(this)"><a target="_blank">
						<span class="glyphicon glyphicon-folder-close"></span>
						Your Data
						</a>
					</li>
					<li id="btnAccount" onclick="sideBarChange(this)"><a target="_blank"><span class="glyphicon glyphicon-list"></span>Your Account</a></li>
							</ul>
						</div>
					</div>
				</nav>


		<div id="main" class="row">
			<div id="sidebar" class="col-lg-4">
				<h2>Announcements</h2>
				<ul>
					<li><p>Welcome back! Health Plus is glad to have you!</p></li>
					<li><p>Health Plus will be down for scheduled maintenance on February 2nd 01:00:00GMT. Thank you for your patience and understanding.</p></li>
					<li><p>Next month we are proud to announce we will be rolling out our newest feature, Fitness Plus! You'll be able to add a record (public or private) of your physical activities and calorie intake to help you meet your fitness goals. Stay Healthy! </p></li>
				</ul>
			</div>
			<div class="col-lg-8">
				<div id="dataview" class="jumbotron"style="height:610px;width:700;padding:5px;">
				</div>
			</div>
		
		</div>
		<hr>
		<div id="footer" class="row">
			<div class="col-xs-12">
				<footer>
					<p>&copy; Noun Project Contributers: Brian Oppenlander, Edward Boatman, Mister Pixel, icon 54, Martha Ormiston, useiconc.com, Creative Stall</p>
				</footer>
			</div>
		</div>
	</div>

</body>
</html>       